<html>
<head>
<link rel="stylesheet" type="text/css" href="scripts/c3.css" >
<link rel="stylesheet" type="text/css" href="scripts/datatables.css"/>

<script type="text/javascript" src="scripts/c3.js"></script>
<script type="text/javascript" src="scripts/d3.min.js" charset="utf-8"></script>
<script type="text/javascript" src="scripts/datatables.min.js"></script>

<style>
#overlay {
    position: absolute;
    background-color: white; 
    z-index: 2;
    display: '';
}
</style>
</head>
<body>
<script>

var openFile = function(event) {
    var input = event.target;

    var reader = new FileReader();
    reader.onload = function(){
      var $table = $("#results");
      var text = reader.result;
      
        text.split("\n").forEach(function(row,rowIndex){
           if(row.length<5){
               return;
           }
          
           var $line = $("<tr></tr>")     
            row.split("\t").forEach(function(col,colIndex){
                $line.append($("<td></td>").html(col))
            });
            
        $table.append($line)
        });
        
        
        $table.prepend('<thead></thead>')
        $table.find('thead').append($table.find("tr:eq(0)"))

        $table.find('thead').find("td").each(function(x,y){ 
            val=y.innerText;
            $('#dim1').append($('<option>', {value:x, text:val}));
            $('#dim2').append($('<option>', {value:x, text:val}));
        });
        



        $table.appendTo(document.body);
        $table.DataTable({
            colReorder: true,
            paging:         false,
            scrollY:        300,
            scrollX:        true,
            scrollCollapse: true,
            fixedColumns:   true,
            keys:           true,
            dom: 'Bfrtip',
            buttons: [
            {
                extend: 'copy',
                exportOptions: {
                    columns: ':visible'
                }
            }, 'colvis'],
                columnDefs: [ {
            visible: false
                } ]
            
            });

    $('#results tbody').on('click', 'tr', function () {
        var  table =  $('#results').DataTable();
        fname=table.row(this).data()[1] + "\\" + table.row(this).data()[0] + "_thumb.png";
        setup_overlay(fname);
    } );


    };
        reader.readAsText(input.files[0]);
 };

function setup_overlay(fname){
    $("#overlay_image")[0].src=fname;
    $("#overlay")[0].style.left=event.clientX + "px";
    $("#overlay")[0].style.top=event.clientY + "px";
    $("#overlay")[0].style.position="absolute";
    overlay_on();
}

function overlay_on() {
    document.getElementById("overlay").style.display = "block";
}

function overlay_off() {
    document.getElementById("overlay").style.display = "none";
}


function drawGraph(){
    $('#chart').remove()
    $('#charts').append("<div id='chart'/>")
    var table = $('#results').DataTable();
    dim1=$('#dim1').val();
    data=table.columns([0,dim1]).data().toArray()
    //json_data=JSON.stringify(data)
    var chart = c3.generate({
    bindto: '#chart',
    tooltip:{
                grouped: false
        },
    data:{
        rows: data,
        type: 'bar',
        onclick: function(e){
            var  table =  $('#results').DataTable();
            fname=table.cells(":contains("+e.id+")",":contains(outdir)").data()[0] + "\\" + e.id + "_thumb.png";
            setup_overlay(fname);
            console.log(e);
            }
        },
    });
}

function clearAllGraphs(){
    $('.c3').remove()
}

function drawAllGraphs(){
    var table = $('#results').DataTable();

    table.columns().every( function () {
        index=this.index()
        data=table.columns([0,index]).data().toArray()

        if(data.length==1 || isNaN(parseFloat(data[1][0]))) {
            return;
        }
         
        header=this.header().innerText
        newdiv="chart_"+index
        $('#charts').append("<div id='"+newdiv+"'/>")
        
        var chart = c3.generate({
            title: {
                text: header
            },
            tooltip:{
                grouped: false
            },
            bindto: "#"+newdiv,
            data:{
                rows: data,
                type: 'bar',
                        onclick: function(e){
            var  table =  $('#results').DataTable();
            fname=table.cells(":contains("+e.id+")",":contains(outdir)").data()[0] + "\\" + e.id + "_thumb.png";
            setup_overlay(fname);
            console.log(e);
            }

           }});       
    } );
}


</script>


<input type='file' accept=".tsv" onchange='openFile(event)'><br>


<div id="overlay" onclick="overlay_off()">
  <div id="img"><img id="overlay_image" src=""></div>
</div>

<table id='results' class='display' width='10000px'><tbody></tbody></table>



Y-Axis 1: <select id="dim1" onchange="drawGraph()">  </select> <br>

<input type=button value="Draw All" onclick='drawAllGraphs()'>
<input type=button value="Clear All" onclick='clearAllGraphs()'>

</body>
<div id="charts"/>
</html>
